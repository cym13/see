#!/bin/bash
set -e -u

#######################################
# Configuration
#######################################

# What video player do you want to use?
PLAYER=mpv

# What format will be recognized as possible embeded videos
FORMATS="youtube.com \.mp4 \.avi \.webm"

# Should we launch some tests?
DEBUG=false

#######################################
# Extensions
#######################################
# Used to perform domain specific actions, just define a function whose name
# is the target domain and it will be executed with maximum priority.

livecoding.tv() {
    curl -s "$1" |\
    tr '"' '\n'  |\
    grep rtmp    |\
    xargs "$PLAYER"
}

#######################################
# Internals
#######################################

domain() {
    sed -n '\|http|s|^https\?://\([^/]\+\)/.*$|\1|p' <<< "$1"
}

scheme() {
    sed -n "\|://|s|^\([^:]\+\)://.*$|\1|p" <<< "$1"
}

get_videos() {
    content="$(curl -s "$1")"

    for format in $FORMATS ; do
        echo "$content" |\
        tr "'\"" "\n\n" |\
        grep "$format"
    done
}

normalize_url() {
    sed "\|^[^/:][^:]\+$|s|^|/| ; \|^/|s|^|$(scheme "$1")://$(domain "$1")|"
}

# Some debug tests, not exactly unittests but useful for debugging
tests() {
scheme "http://home/cym13/.home.html/"
domain "http://home/cym13/.home.html/"

normalize_url "http://my_site.com/thingy/" <<EOF
/a/video.mp4
video.mp4
http://my_site.com/a/video.mp4
EOF

}

main() {
    if $DEBUG ; then
        tests
    fi

    local url="${1:-""}"

    # No arguments given
    if [[ -z "$url" ]] ; then
        echo "Usage: see URLS..."
        exit 1
    fi

    # Try the extension function
    if "$(domain "$url")" 2>/dev/null ; then
        exit 0
    fi

    # Try with the default player
    if "$PLAYER" "$url" ; then
        exit 0
    fi

    # If it isn't a url, quit
    if [[ -z "$(scheme "$url")" ]] ; then
        exit 1
    fi

    # Try automatically finding embeded urls
    local urls="$(get_videos "$url")"

    if [[ -z "$urls" ]] ; then
        exit 1
    fi

    uniq <<<"$urls"      |\
    normalize_url "$url" |\
    tr "\n" "\0"         |\
    xargs -0 "$PLAYER"
}

main "$@"
